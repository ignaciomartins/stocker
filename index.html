<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestor de Stock - Exportador</title>
<style>
  :root{
    --bg:#f6f6f7;
    --card:#efefef;
    --accent:#4b5cff;
    --muted:#666;
    --radius:12px;
    --gap:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:#111;}
  .app{max-width:960px;margin:0 auto;padding:16px;}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px;}
  header img{height:44px;border-radius:8px;object-fit:cover}
  header h1{font-size:18px;margin:0}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(75,92,255,0.15);}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);min-width:140px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;}
  /* card */
  .card{background:var(--card);border-radius:var(--radius);padding:12px}
  .card .titleRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .titleRow h2{font-size:15px;margin:0}
  .titleRow .small{font-size:12px;color:var(--muted)}
  .product{padding:8px 0;border-top:1px dashed rgba(0,0,0,0.05)}
  .product:first-of-type{border-top:0;padding-top:0}
  .prodTitle{font-weight:600;margin-bottom:6px}
  .variantRow{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:4px 0}
  .variantLeft{display:flex;align-items:center;gap:8px}
  .qtyBtn{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px;border:0;background:#fff;color:var(--accent);box-shadow:0 1px 0 rgba(0,0,0,0.06);font-weight:700;cursor:pointer}
  .qtyBox{min-width:36px;text-align:center;font-weight:600}
  .controls{display:flex;gap:6px;align-items:center}
  .tiny{font-size:13px;padding:6px 8px;border-radius:8px;background:#fff;border:0}
  .muted{color:var(--muted);font-size:13px}
  .rowBetween{display:flex;justify-content:space-between;align-items:center}
  .mini{padding:6px 8px;font-size:13px;border-radius:8px}
  .delBtn{background:transparent;color:#b33;border:0;font-weight:700;cursor:pointer}
  .footer{margin-top:14px;display:flex;gap:8px;align-items:center}
  .output{white-space:pre-wrap;background:#fff;padding:12px;border-radius:8px;margin-top:12px;border:1px solid rgba(0,0,0,0.04);font-family:monospace;font-size:14px}
  /* responsive */
  @media(min-width:720px){
    .grid{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <!-- imagen subida por el usuario, ruta local de la sesión: -->
    <img src="/mnt/data/4 ・ Large@1x.png" alt="logo/subida" onerror="this.style.display='none'"/>
    <div>
      <h1>Gestor de Stock — REAL FULLSTACK</h1>
      <div class="muted">Móvil primero · Copiar por categoría · Guardado automático</div>
    </div>
  </header>

  <div class="actions">
    <input id="newCatName" type="text" placeholder="Nueva categoría (ej. Caja Marron)" />
    <button id="addCategory">Agregar categoría</button>

    <input id="search" type="text" placeholder="Buscar categoría / modelo / color" />
    <button id="exportAll" class="ghost">Exportar todo</button>
    <button id="clearAll" class="ghost" title="Eliminar todo (localStorage)">Borrar todo</button>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    <button id="copyAll" class="mini">Copiar todo</button>
    <div class="muted">Resultado generado automáticamente</div>
  </div>

  <div id="output" class="output" aria-live="polite"></div>
</div>

<script>
/*
  Estructura de datos:
  {
    "Caja Marron": {
       "14 Pro Max 512gb": { "Purple": 1, "Black": 0 },
       "14 Pro Max 1Tb": { "Purple": 2 }
    },
    "Asis": { ... }
  }
*/

const STORAGE_KEY = 'stock_export_data_v1';

// Datos iniciales (ejemplo)
const initialData = {
  "Caja Marron": {
    "14 Pro Max 512gb": { "Purple": 1 },
    "14 Pro Max 1Tb": { "Purple": 2 }
  },
  "Asis": {
    "16 Pro 128gb": { "White": 2, "Black": 3 },
    "14 Pro Max 1Tb": { "Purple": 1 }
  },
  "Tester": {
    "13 128gb": { "Midnight": 2, "Blue": 3 },
    "16 128gb": { "Pink": 1 }
  }
};

let data = loadData();

// Elements
const grid = document.getElementById('grid');
const newCatName = document.getElementById('newCatName');
const addCategoryBtn = document.getElementById('addCategory');
const exportAllBtn = document.getElementById('exportAll');
const copyAllBtn = document.getElementById('copyAll');
const clearAllBtn = document.getElementById('clearAll');
const output = document.getElementById('output');
const searchInput = document.getElementById('search');

addCategoryBtn.onclick = () => {
  const name = newCatName.value.trim();
  if(!name) return alert('Ingresá el nombre de la categoría');
  if(data[name]) return alert('La categoría ya existe');
  data[name] = {};
  saveAndRender();
  newCatName.value = '';
};

clearAllBtn.onclick = () => {
  if(!confirm('¿Seguro? Esto borrará todo lo guardado en este dispositivo.')) return;
  localStorage.removeItem(STORAGE_KEY);
  data = {};
  saveAndRender();
};

exportAllBtn.onclick = () => {
  const txt = generateFullText(data);
  output.textContent = txt;
  // también copiar al portapapeles
  copyToClipboard(txt).then(()=>flashMsg('Copiado todo al portapapeles'));
};

copyAllBtn.onclick = () => {
  const txt = generateFullText(data);
  copyToClipboard(txt).then(()=>flashMsg('Copiado todo al portapapeles'));
};

// Búsqueda simple
searchInput.addEventListener('input', () => {
  render();
});

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  // si no hay, usar inicial
  localStorage.setItem(STORAGE_KEY, JSON.stringify(initialData));
  return JSON.parse(JSON.stringify(initialData));
}

function saveAndRender(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  render();
  // actualizar output principal también
  output.textContent = generateFullText(data);
}

// render
function render(){
  grid.innerHTML = '';
  const q = searchInput.value.trim().toLowerCase();
  const cats = Object.keys(data);
  if(cats.length === 0){
    grid.innerHTML = '<div class="card">No hay categorías. Agregá una arriba.</div>';
    output.textContent = '';
    return;
  }

  cats.forEach(cat => {
    // filtro por búsqueda: si la categoría, algún producto o color contiene la query, mostrar
    if(q){
      const catLower = cat.toLowerCase();
      let matches = catLower.includes(q);
      if(!matches){
        for(const prod of Object.keys(data[cat])){
          if(prod.toLowerCase().includes(q)){ matches = true; break; }
          for(const col of Object.keys(data[cat][prod])){
            if(col.toLowerCase().includes(q)){ matches = true; break; }
          }
          if(matches) break;
        }
      }
      if(!matches) return; // skip
    }

    const card = document.createElement('div'); card.className = 'card';
    const titleRow = document.createElement('div'); titleRow.className = 'titleRow';
    const h2 = document.createElement('h2'); h2.textContent = cat;
    const rightControls = document.createElement('div');

    const btnAddModel = document.createElement('button'); btnAddModel.textContent = 'Agregar modelo';
    btnAddModel.onclick = () => {
      const model = prompt('Nombre del modelo/producto (ej. 14 Pro Max 512gb):');
      if(!model) return;
      if(data[cat][model]) return alert('El modelo ya existe en esta categoría');
      data[cat][model] = {};
      saveAndRender();
    };

    const btnCopyCat = document.createElement('button'); btnCopyCat.textContent = 'Copiar';
    btnCopyCat.title = 'Copiar solo esta categoría';
    btnCopyCat.onclick = async () => {
      const txt = generateCategoryText(cat, data[cat]);
      await copyToClipboard(txt);
      flashMsg(`Copiado "${cat}" al portapapeles`);
    };

    const btnDeleteCat = document.createElement('button'); btnDeleteCat.textContent = 'Eliminar';
    btnDeleteCat.className = 'delBtn';
    btnDeleteCat.onclick = () => {
      if(!confirm(`Eliminar categoría "${cat}"?`)) return;
      delete data[cat];
      saveAndRender();
    };

    rightControls.appendChild(btnAddModel);
    rightControls.appendChild(btnCopyCat);
    rightControls.appendChild(btnDeleteCat);

    titleRow.appendChild(h2);
    titleRow.appendChild(rightControls);
    card.appendChild(titleRow);

    const prods = Object.keys(data[cat]);
    if(prods.length === 0){
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'Sin modelos. Agregá uno con "Agregar modelo".';
      card.appendChild(empty);
    }

    prods.forEach(prod => {
      const prodDiv = document.createElement('div'); prodDiv.className = 'product';
      const prodTitleRow = document.createElement('div'); prodTitleRow.className = 'rowBetween';
      const prodTitle = document.createElement('div'); prodTitle.className='prodTitle'; prodTitle.textContent = prod;

      const prodControls = document.createElement('div');
      const btnAddVariant = document.createElement('button'); btnAddVariant.textContent = 'Agregar variante';
      btnAddVariant.className = 'tiny';
      btnAddVariant.onclick = () => {
        const col = prompt('Nombre de la variante/color (ej. Purple)');
        if(!col) return;
        if(data[cat][prod][col] !== undefined) return alert('La variante ya existe');
        data[cat][prod][col] = 0;
        saveAndRender();
      };

      const btnDelProd = document.createElement('button'); btnDelProd.textContent = 'Eliminar modelo';
      btnDelProd.className = 'delBtn';
      btnDelProd.onclick = () => {
        if(!confirm(`Eliminar modelo "${prod}" de "${cat}"?`)) return;
        delete data[cat][prod];
        saveAndRender();
      };

      prodControls.appendChild(btnAddVariant);
      prodControls.appendChild(btnDelProd);
      prodTitleRow.appendChild(prodTitle);
      prodTitleRow.appendChild(prodControls);
      prodDiv.appendChild(prodTitleRow);

      const variants = Object.keys(data[cat][prod]);
      if(variants.length === 0){
        const vEmpty = document.createElement('div');
        vEmpty.className = 'muted';
        vEmpty.textContent = 'Sin variantes. Agregá una con "Agregar variante".';
        prodDiv.appendChild(vEmpty);
      }

      variants.forEach(variant => {
        const vr = document.createElement('div'); vr.className = 'variantRow';
        const left = document.createElement('div'); left.className = 'variantLeft';
        const nameSpan = document.createElement('div'); nameSpan.textContent = variant;
        const controls = document.createElement('div'); controls.className='controls';

        const minus = document.createElement('button'); minus.className='qtyBtn'; minus.textContent='−';
        const qtyBox = document.createElement('div'); qtyBox.className='qtyBox'; qtyBox.textContent = data[cat][prod][variant] || 0;
        const plus = document.createElement('button'); plus.className='qtyBtn'; plus.textContent='+';

        minus.onclick = () => {
          if(data[cat][prod][variant] > 0){
            data[cat][prod][variant]--;
            qtyBox.textContent = data[cat][prod][variant];
            saveAndRender();
          }
        };
        plus.onclick = () => {
          data[cat][prod][variant]++;
          qtyBox.textContent = data[cat][prod][variant];
          saveAndRender();
        };

        const btnRename = document.createElement('button'); btnRename.className='tiny'; btnRename.textContent='Renombrar';
        btnRename.onclick = ()=>{
          const nn = prompt('Nuevo nombre para la variante', variant);
          if(!nn || nn === variant) return;
          if(data[cat][prod][nn] !== undefined) return alert('Ya existe una variante con ese nombre');
          data[cat][prod][nn] = data[cat][prod][variant];
          delete data[cat][prod][variant];
          saveAndRender();
        };

        const btnDelVar = document.createElement('button'); btnDelVar.className='delBtn'; btnDelVar.textContent='Eliminar';
        btnDelVar.onclick = ()=>{
          if(!confirm(`Eliminar variante "${variant}"?`)) return;
          delete data[cat][prod][variant];
          saveAndRender();
        };

        controls.appendChild(minus);
        controls.appendChild(qtyBox);
        controls.appendChild(plus);
        controls.appendChild(btnRename);
        controls.appendChild(btnDelVar);

        left.appendChild(nameSpan);
        vr.appendChild(left);
        vr.appendChild(controls);
        prodDiv.appendChild(vr);
      });

      card.appendChild(prodDiv);
    });

    // botón para copiar texto solo de la categoría (también arriba hay uno)
    const copyAreaBtn = document.createElement('button');
    copyAreaBtn.textContent = 'Copiar formato';
    copyAreaBtn.className = 'mini';
    copyAreaBtn.onclick = async () => {
      const txt = generateCategoryText(cat, data[cat]);
      await copyToClipboard(txt);
      flashMsg(`Copiado "${cat}"`);
    };
    card.appendChild(document.createElement('div'));
    card.lastChild.appendChild(copyAreaBtn); // small spacer

    grid.appendChild(card);
  });
}

// Generadores de texto
function generateCategoryText(categoryName, catObj){
  let out = `_${categoryName}_\n`;
  Object.keys(catObj).forEach(product => {
    out += product + '\n';
    const colors = Object.keys(catObj[product]);
    colors.forEach(color => {
      const qty = catObj[product][color];
      if(qty > 0) out += `${color} x${qty}\n`;
    });
    out += '\n';
  });
  return out.trim();
}

function generateFullText(obj){
  let out = '';
  Object.keys(obj).forEach(cat => {
    out += `_${cat}_\n`;
    Object.keys(obj[cat]).forEach(product => {
      out += product + '\n';
      Object.keys(obj[cat][product]).forEach(color => {
        const qty = obj[cat][product][color];
        if(qty > 0) out += `${color} x${qty}\n`;
      });
      out += '\n';
    });
  });
  return out.trim();
}

// util: copy al portapapeles
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
}

// pequeña notificación visual
function flashMsg(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed';
  el.style.right='14px';
  el.style.top='14px';
  el.style.background='var(--accent)';
  el.style.color='#fff';
  el.style.padding='8px 12px';
  el.style.borderRadius='8px';
  el.style.boxShadow='0 6px 20px rgba(0,0,0,0.08)';
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity='0',1400);
  setTimeout(()=>el.remove(),2000);
}

// Guardar con debounce para evitar demasiadas escrituras
let saveTimer = null;
function saveDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }, 300);
}

function saveAndRenderDebounced(){
  saveDebounced();
  render();
  output.textContent = generateFullText(data);
}

// Overwrite saveAndRender with debounce where appropriate
function saveAndRender(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  render();
  output.textContent = generateFullText(data);
}

// Inicial
render();
output.textContent = generateFullText(data);

// Facil: permitir crear categoría con Enter
newCatName.addEventListener('keyup', (e)=>{
  if(e.key === 'Enter') addCategoryBtn.click();
});

// Exportar (descarga .txt)
exportAllBtn.addEventListener('click', ()=>{
  const txt = generateFullText(data);
  const blob = new Blob([txt], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'export_stock.txt';
  a.click();
  URL.revokeObjectURL(url);
});

// permitir copiar todo también con copyAllBtn
copyAllBtn.addEventListener('click', async ()=>{
  const txt = generateFullText(data);
  await copyToClipboard(txt);
  flashMsg('Copiado todo al portapapeles');
});

</script>
</body>
</html>
