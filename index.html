<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Gestor de Stock — Dinámico</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --muted:#666; --accent:#2b6cb0;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#111}
  .app{max-width:980px;margin:0 auto;padding:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px}
  button.btn{border:0;padding:8px 10px;border-radius:10px;background:#222;color:#fff;font-weight:600}
  button.ghost{background:transparent;border:1px solid #ddd;padding:8px 10px;border-radius:10px}
  /* Category card */
  .cat{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
  .cat-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .cat-left{display:flex;flex-direction:column}
  .cat-title{font-weight:700}
  .cat-meta{font-size:13px;color:var(--muted)}
  .cat-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:none;color:var(--accent);font-weight:700;cursor:pointer;padding:6px;border-radius:8px}
  .icon-btn.danger{color:#c23}
  /* body */
  .cat-body{margin-top:10px}
  .model{padding:6px 6px 6px 8px;border-radius:8px;margin-bottom:8px;background:#fbfcff}
  .model-name{font-weight:600}
  .models-list{padding-left:8px}
  .model-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .variants{margin-top:6px;padding-left:8px}
  .variant{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px;border-radius:8px}
  .variant-left{display:flex;flex-direction:column;gap:4px}
  .variant-name{font-weight:500}
  .variant-note{font-size:13px;color:var(--muted)}
  .qty{min-width:40px;text-align:center;padding:6px;border-radius:8px;background:#eef2ff}
  input[type="text"], input[type="number"]{font-size:16px;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
  input.small{font-size:15px;padding:6px}
  .add-row{display:flex;gap:8px;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  /* responsive */
  @media (max-width:600px){
    .model-row{flex-direction:column;align-items:flex-start}
    .variant{flex-direction:column;align-items:flex-start}
    .cat{padding:10px}
    header{gap:6px}
  }
  /* toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .18s}
  .toast.show{opacity:1;pointer-events:auto}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Gestor de Stock</h1>
      <div class="controls">
        <button class="btn" id="addCat">+ Categoria</button>
        <button class="ghost" id="exportAll">Exportar todo</button>
      </div>
    </header>

    <main id="root"></main>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* ------------------------
  Data + persistencia
   ------------------------ */
const STORAGE_KEY = 'stock_app_v2';
const uid = ()=>Math.random().toString(36).slice(2,9);

let state = loadState();
if(!state || state.length === 0){
  state = [
    { id:uid(), name:'Caja Marron', collapsed:false, models:[
      { id:uid(), name:'14 Pro Max 512gb', variants:[ { id:uid(), name:'Purple', qty:1, note:'' } ] },
      { id:uid(), name:'14 Pro Max 1TB', variants:[ { id:uid(), name:'Purple', qty:2, note:'' } ] }
    ]},
    { id:uid(), name:'Asis', collapsed:false, models:[
      { id:uid(), name:'16 Pro 128gb', variants:[ { id:uid(), name:'White', qty:2, note:'' }, { id:uid(), name:'Black', qty:3, note:'' } ] }
    ]}
  ];
  saveState();
}

function loadState(){ try{ const r = localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):[] }catch(e){return []} }
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* --------------- UI helpers --------------- */
const root = document.getElementById('root');
const toastEl = document.getElementById('toast');
function toast(msg, t=1400){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), t); }

/* --------------- Render --------------- */
function render(){
  root.innerHTML = '';
  state.forEach(cat => {
    const catCard = document.createElement('div'); catCard.className = 'cat';

    // header
    const head = document.createElement('div'); head.className = 'cat-head';
    const left = document.createElement('div'); left.className = 'cat-left';
    const title = document.createElement('div'); title.className='cat-title'; title.textContent = '*_' + cat.name + '_*';
    const meta = document.createElement('div'); meta.className='cat-meta'; meta.textContent = `${cat.models.length} modelo(s)`;
    left.appendChild(title); left.appendChild(meta);

    const actions = document.createElement('div'); actions.className='cat-actions';
    const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.textContent='Copiar'; copyBtn.title='Copiar solo esta categoría';
    copyBtn.onclick = ()=>copyCategory(cat.id);

    const addModelBtn = document.createElement('button'); addModelBtn.className='icon-btn'; addModelBtn.textContent='+'; addModelBtn.title='Agregar modelo';
    addModelBtn.onclick = ()=>{ promptAddModel(cat.id); };

    const delCatBtn = document.createElement('button'); delCatBtn.className='icon-btn danger'; delCatBtn.textContent='Eliminar';
    delCatBtn.onclick = ()=>{ if(confirm(`Eliminar categoría "${cat.name}"?`)){ state = state.filter(c=>c.id!==cat.id); saveState(); render(); } };

    const caret = document.createElement('button'); caret.className='icon-btn'; caret.textContent = cat.collapsed ? '▸' : '▾';
    caret.onclick = ()=>{ cat.collapsed = !cat.collapsed; saveState(); render(); };

    actions.appendChild(copyBtn);
    actions.appendChild(addModelBtn);
    actions.appendChild(delCatBtn);
    actions.appendChild(caret);

    head.appendChild(left); head.appendChild(actions);
    catCard.appendChild(head);

    // body (accordion)
    const body = document.createElement('div'); body.className='cat-body';
    body.style.display = cat.collapsed ? 'none' : 'block';

    // models
    const modelsList = document.createElement('div'); modelsList.className='models-list';
    cat.models.forEach(model => {
      const modelBox = document.createElement('div'); modelBox.className='model';
      const mRow = document.createElement('div'); mRow.className='model-row';

      const mLeft = document.createElement('div');
      const mName = document.createElement('div'); mName.className='model-name'; mName.textContent = model.name;
      const mSmall = document.createElement('div'); mSmall.className='small'; mSmall.textContent = `${model.variants.length} variante(s)`;
      mLeft.appendChild(mName); mLeft.appendChild(mSmall);

      const mActions = document.createElement('div');
      const addVarBtn = document.createElement('button'); addVarBtn.className='icon-btn'; addVarBtn.textContent='+'; addVarBtn.title='Agregar variante';
      addVarBtn.onclick = ()=> promptAddVariant(cat.id, model.id);

      const delModelBtn = document.createElement('button'); delModelBtn.className='icon-btn danger'; delModelBtn.textContent='Eliminar';
      delModelBtn.onclick = ()=>{ if(confirm(`Eliminar modelo "${model.name}"?`)){ cat.models = cat.models.filter(m=>m.id!==model.id); saveState(); render(); } };

      mActions.appendChild(addVarBtn); mActions.appendChild(delModelBtn);

      mRow.appendChild(mLeft); mRow.appendChild(mActions);
      modelBox.appendChild(mRow);

      // variants
      const variantsEl = document.createElement('div'); variantsEl.className='variants';
      model.variants.forEach(variant => {
        const v = document.createElement('div'); v.className='variant';

        const vLeft = document.createElement('div'); vLeft.className='variant-left';
        const vName = document.createElement('div'); vName.className='variant-name'; vName.textContent = variant.name;
        const vNote = document.createElement('div'); vNote.className='variant-note'; vNote.textContent = variant.note || '';
        if(!(variant.note || '').trim()) vNote.style.display = 'none';
        vLeft.appendChild(vName); vLeft.appendChild(vNote);

        const vRight = document.createElement('div'); vRight.style.display='flex'; vRight.style.alignItems='center'; vRight.style.gap='8px';

        const minus = document.createElement('button'); minus.className='icon-btn'; minus.textContent='-';
        minus.onclick = ()=>{ if(variant.qty>0) variant.qty--; saveState(); render(); };

        const qty = document.createElement('div'); qty.className='qty'; qty.textContent = variant.qty;

        const plus = document.createElement('button'); plus.className='icon-btn'; plus.textContent='+';
        plus.onclick = ()=>{ variant.qty++; saveState(); render(); };

        const edit = document.createElement('button'); edit.className='icon-btn'; edit.textContent='Editar';
        edit.onclick = ()=> editVariant(cat.id, model.id, variant.id);

        const del = document.createElement('button'); del.className='icon-btn danger'; del.textContent='Eliminar';
        del.onclick = ()=>{ if(confirm(`Eliminar variante "${variant.name}"?`)){ model.variants = model.variants.filter(x=>x.id!==variant.id); saveState(); render(); } };

        vRight.appendChild(minus); vRight.appendChild(qty); vRight.appendChild(plus); vRight.appendChild(edit); vRight.appendChild(del);

        v.appendChild(vLeft); v.appendChild(vRight);
        variantsEl.appendChild(v);
      });

      modelBox.appendChild(variantsEl);
      modelsList.appendChild(modelBox);
    });

    // add model inline row
    const addModelRow = document.createElement('div'); addModelRow.className='add-row';
    const modelInput = document.createElement('input'); modelInput.type='text'; modelInput.placeholder='Nuevo modelo (ej: AirPods)'; modelInput.style.flex='1'; modelInput.style.fontSize='16px';
    const modelAdd = document.createElement('button'); modelAdd.className='icon-btn'; modelAdd.textContent='+';
    modelAdd.onclick = ()=>{
      const val = modelInput.value.trim();
      if(!val) return toast('Ingresá nombre de modelo');
      cat.models.push({ id:uid(), name:val, variants:[] });
      modelInput.value=''; saveState(); render();
    };
    addModelRow.appendChild(modelInput); addModelRow.appendChild(modelAdd);

    body.appendChild(modelsList);
    body.appendChild(addModelRow);

    catCard.appendChild(body);
    root.appendChild(catCard);
  });

  // tiny footer space
  const spacer = document.createElement('div'); spacer.style.height='60px';
  root.appendChild(spacer);
}

/* --------------- Actions --------------- */
function promptAddModel(catId){
  const cat = state.find(c=>c.id===catId);
  const name = prompt('Nombre del modelo:');
  if(name && name.trim()){ cat.models.push({ id:uid(), name:name.trim(), variants:[] }); saveState(); render(); }
}

function promptAddVariant(catId, modelId){
  const cat = state.find(c=>c.id===catId);
  const model = cat.models.find(m=>m.id===modelId);
  const vname = prompt('Nombre variante (ej: Purple or Max):');
  if(!vname || !vname.trim()) return;
  const qtyStr = prompt('Cantidad (numero):','1');
  const qty = Math.max(0, parseInt(qtyStr)||0);
  const note = prompt('Nota / sub-variantes (opcional):','');
  model.variants.push({ id:uid(), name:vname.trim(), qty, note: note?note.trim():'' });
  saveState(); render();
}

function editVariant(catId, modelId, variantId){
  const cat = state.find(c=>c.id===catId);
  const model = cat.models.find(m=>m.id===modelId);
  const variant = model.variants.find(v=>v.id===variantId);
  const newName = prompt('Editar nombre variante:', variant.name);
  if(newName!==null) variant.name = newName.trim();
  const newQty = prompt('Editar cantidad:', variant.qty);
  if(newQty!==null) variant.qty = Math.max(0, parseInt(newQty)||0);
  const newNote = prompt('Editar nota (opcional):', variant.note||'');
  if(newNote!==null) variant.note = newNote.trim();
  saveState(); render();
}

/* Copy single category formatted like you requested:
   Category header: "*_Categoria_*"
   Then:
   Modelo
   Variante xN (nota)   (only if qty>0)
   <blank line between models>
*/
async function copyCategory(catId){
  const cat = state.find(c=>c.id===catId);
  if(!cat) return;
  let out = `*_` + cat.name + `_*\n\n`;
  cat.models.forEach(m=>{
    out += m.name + '\n';
    m.variants.forEach(v=>{
      if(v.qty > 0){
        out += v.name + ' x' + v.qty;
        if(v.note && v.note.trim()) out += ' (' + v.note + ')';
        out += '\n';
      }
    });
    out += '\n';
  });
  out = out.trim();
  try{
    await navigator.clipboard.writeText(out);
    toast('Copiado al portapapeles');
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = out;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast('Copiado (fallback)');
  }
}

/* Export all as single text + copy */
async function exportAll(){
  let out = '';
  state.forEach(cat=>{
    out += '*_' + cat.name + '_*' + '\n\n';
    cat.models.forEach(m=>{
      out += m.name + '\n';
      m.variants.forEach(v=>{
        if(v.qty>0){
          out += v.name + ' x' + v.qty;
          if(v.note && v.note.trim()) out += ' ('+v.note+')';
          out += '\n';
        }
      });
      out += '\n';
    });
    out += '\n';
  });
  out = out.trim();
  try{ await navigator.clipboard.writeText(out); toast('Todo copiado'); }catch(e){ prompt('Texto exportado:', out); }
}

/* --------------- Top controls wiring --------------- */
document.getElementById('addCat').onclick = ()=>{
  const name = prompt('Nombre de la categoría:');
  if(!name || !name.trim()) return;
  state.push({ id:uid(), name: name.trim(), collapsed:false, models:[] });
  saveState(); render();
};
document.getElementById('exportAll').onclick = exportAll;

/* initial render */
render();
</script>
</body>
</html>
