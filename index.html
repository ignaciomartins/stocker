<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor de Stock - Dinámico</title>
  <style>
    :root{--bg:#f8f9fb;--card:#ffffff;--muted:#666;--accent:#2b6cb0}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:var(--bg);color:#111}
    .app{max-width:1024px;margin:0 auto;padding:14px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}

    /* layout */
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button.icon{background:#222;color:#fff;border:none;padding:8px 10px;border-radius:8px;font-weight:600}
    button.ghost{background:transparent;border:1px solid #ddd;padding:8px 10px;border-radius:8px}

    /* categories */
    .category{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .cat-head{display:flex;align-items:center;justify-content:space-between}
    .cat-title{font-weight:700}
    .cat-actions{display:flex;gap:8px;align-items:center}
    .cat-body{margin-top:10px}

    .model{padding:6px 6px 6px 8px;border-radius:8px;margin-bottom:6px}
    .model-name{font-weight:600}
    .variants{padding-left:8px;margin-top:6px}
    .variant{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;border-radius:6px}
    .variant-left{display:flex;align-items:center;gap:8px}
    .qty{min-width:34px;text-align:center;padding:4px 8px;border-radius:6px;background:#eef2ff}

    .small{font-size:13px;color:var(--muted)}

    .row-actions{display:flex;gap:6px}

    input[type="text"], textarea{font-size:16px;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
    textarea{min-height:80px}

    .import-box{margin-top:8px}

    /* responsive mobile friendly */
    @media (max-width:600px){
      .app{padding:10px}
      .cat-head{gap:8px}
      button.icon{padding:8px}
      .variant{flex-direction:column;align-items:flex-start;gap:6px}
      .variant .qty{align-self:flex-end}
    }

    /* accordion caret */
    .caret{font-size:18px;padding:6px 8px;border-radius:6px}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none}
    .toast.show{opacity:1;pointer-events:auto}

    /* small link style */
    .linkish{background:transparent;border:none;color:var(--accent);font-weight:600;cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Gestor de Stock — Móvil</h1>
      <div class="controls">
        <button class="icon" id="addCatBtn">+  Categoria</button>
        <button class="ghost" id="exportAll">Exportar todo</button>
      </div>
    </header>

    <main id="cats"></main>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="ghost" id="clearAll">Limpiar todo</button>
      <button class="ghost" id="loadExample">Cargar ejemplo</button>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script>
  // Key for localStorage
  const STORAGE_KEY = 'stock_page_v1';

  // Utility helpers
  const $ = sel => document.querySelector(sel);
  const uid = () => Math.random().toString(36).slice(2,9);

  // Default data sample
  const sampleData = [
    {id:uid(),name:'Caja Marron',collapsed:false,models:[
      {id:uid(),name:'14 Pro Max 512gb',variants:[{id:uid(),name:'Purple',qty:1}]},
      {id:uid(),name:'14 Pro Max 1TB',variants:[{id:uid(),name:'Purple',qty:2}]}
    ]},
    {id:uid(),name:'Asis',collapsed:false,models:[
      {id:uid(),name:'16 Pro 128gb',variants:[{id:uid(),name:'White',qty:2},{id:uid(),name:'Black',qty:3}]},
      {id:uid(),name:'14 Pro Max 1TB',variants:[{id:uid(),name:'Purple',qty:1}]}
    ]},
    {id:uid(),name:'Tester',collapsed:false,models:[
      {id:uid(),name:'13 128gb',variants:[{id:uid(),name:'Midnight',qty:2},{id:uid(),name:'Blue',qty:3}]},
      {id:uid(),name:'16 128gb',variants:[{id:uid(),name:'Pink',qty:1}]}
    ]}
  ];

  // Load / Save
  function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[] }catch(e){return []} }

  // Current state
  let state = load(); if(!state || state.length===0) state = sampleData;

  // Toast
  function toast(msg, t=1500){ const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t) }

  // Render
  const catsEl = $('#cats');
  function render(){
    catsEl.innerHTML = '';
    state.forEach(cat => {
      const card = document.createElement('div'); card.className = 'category';

      const head = document.createElement('div'); head.className = 'cat-head';
      const left = document.createElement('div');
      const title = document.createElement('div'); title.className = 'cat-title'; title.textContent = cat.name;
      const subtitle = document.createElement('div'); subtitle.className='small'; subtitle.textContent = cat.models.length + ' modelo(s)';
      left.appendChild(title); left.appendChild(subtitle);

      const actions = document.createElement('div'); actions.className='cat-actions';
      const copyBtn = document.createElement('button'); copyBtn.className='linkish'; copyBtn.textContent='Copiar';
      copyBtn.onclick = ()=>{ copyCategory(cat.id); };

      const importBtn = document.createElement('button'); importBtn.className='linkish'; importBtn.textContent='Importar';
      importBtn.onclick = ()=>{ toggleImportBox(cat.id); };

      const addModelBtn = document.createElement('button'); addModelBtn.className='linkish'; addModelBtn.textContent='+';
      addModelBtn.title = 'Agregar modelo'; addModelBtn.onclick = ()=>{ addModel(cat.id); };

      const delCatBtn = document.createElement('button'); delCatBtn.className='linkish'; delCatBtn.textContent='Eliminar';
      delCatBtn.onclick = ()=>{ if(confirm('Eliminar categoria "'+cat.name+'"?')){ state = state.filter(c=>c.id!==cat.id); save(state); render(); } };

      const caret = document.createElement('button'); caret.className='caret'; caret.textContent = cat.collapsed ? '▸' : '▾';
      caret.onclick = ()=>{ cat.collapsed = !cat.collapsed; save(state); render(); };

      actions.appendChild(copyBtn); actions.appendChild(importBtn); actions.appendChild(addModelBtn); actions.appendChild(delCatBtn); actions.appendChild(caret);

      head.appendChild(left); head.appendChild(actions);
      card.appendChild(head);

      // body
      const body = document.createElement('div'); body.className='cat-body'; body.style.display = cat.collapsed ? 'none' : 'block';

      // models
      cat.models.forEach(model => {
        const m = document.createElement('div'); m.className='model';
        const mhead = document.createElement('div'); mhead.style.display='flex'; mhead.style.justifyContent='space-between'; mhead.style.alignItems='center';
        const mleft = document.createElement('div');
        const modelName = document.createElement('div'); modelName.className='model-name'; modelName.textContent = model.name; mleft.appendChild(modelName);
        const msmall = document.createElement('div'); msmall.className='small'; msmall.textContent = model.variants.length + ' variante(s)'; mleft.appendChild(msmall);
        mhead.appendChild(mleft);

        const mactions = document.createElement('div'); mactions.className='row-actions';
        const addVar = document.createElement('button'); addVar.className='linkish'; addVar.textContent='+'; addVar.title='Agregar variante'; addVar.onclick=()=>{ addVariant(cat.id, model.id); };
        const delModel = document.createElement('button'); delModel.className='linkish'; delModel.textContent='Eliminar'; delModel.onclick=()=>{ if(confirm('Eliminar modelo "'+model.name+'"?')){ cat.models = cat.models.filter(m=>m.id!==model.id); save(state); render(); } };
        mactions.appendChild(addVar); mactions.appendChild(delModel);
        mhead.appendChild(mactions);

        m.appendChild(mhead);

        const variantsEl = document.createElement('div'); variantsEl.className='variants';
        model.variants.forEach(variant => {
          const v = document.createElement('div'); v.className='variant';
          const vleft = document.createElement('div'); vleft.className='variant-left';
          const vname = document.createElement('div'); vname.textContent = variant.name + (variant.note?(' '+variant.note):'');
          vleft.appendChild(vname);

          const vright = document.createElement('div'); vright.style.display='flex'; vright.style.alignItems='center'; vright.style.gap='8px';
          const minus = document.createElement('button'); minus.className='linkish'; minus.textContent='-'; minus.onclick=()=>{ if(variant.qty>0){ variant.qty--; save(state); render(); } };
          const qty = document.createElement('div'); qty.className='qty'; qty.textContent = variant.qty;
          const plus = document.createElement('button'); plus.className='linkish'; plus.textContent='+'; plus.onclick=()=>{ variant.qty++; save(state); render(); };
          const edit = document.createElement('button'); edit.className='linkish'; edit.textContent='Editar'; edit.onclick=()=>{ editVariant(cat.id, model.id, variant.id); };
          const delV = document.createElement('button'); delV.className='linkish'; delV.textContent='Eliminar'; delV.onclick=()=>{ if(confirm('Eliminar variante "'+variant.name+'"?')){ model.variants = model.variants.filter(vv=>vv.id!==variant.id); save(state); render(); } };

          vright.appendChild(minus); vright.appendChild(qty); vright.appendChild(plus); vright.appendChild(edit); vright.appendChild(delV);
          v.appendChild(vleft); v.appendChild(vright);
          variantsEl.appendChild(v);
        });

        m.appendChild(variantsEl);
        body.appendChild(m);
      });

      // add model input
      const addModelRow = document.createElement('div'); addModelRow.style.marginTop='8px';
      const modelInput = document.createElement('input'); modelInput.type='text'; modelInput.placeholder='Nombre del modelo (ej: AirPods)'; modelInput.style.width='60%';
      const modelAddBtn = document.createElement('button'); modelAddBtn.className='linkish'; modelAddBtn.textContent='+'; modelAddBtn.onclick=()=>{ const val = modelInput.value.trim(); if(!val) return toast('Ingresá nombre de modelo'); cat.models.push({id:uid(),name:val,variants:[]}); save(state); modelInput.value=''; render(); };
      addModelRow.appendChild(modelInput); addModelRow.appendChild(modelAddBtn);
      body.appendChild(addModelRow);

      // import box (hidden by default)
      const importBox = document.createElement('div'); importBox.className='import-box'; importBox.style.display='none';
      importBox.id = 'import-'+cat.id;
      const importLabel = document.createElement('div'); importLabel.className='small'; importLabel.textContent='Pegar bloque de texto para importar (usa formato: Modelo + variantes en líneas con \" xN\"): '; importBox.appendChild(importLabel);
      const t = document.createElement('textarea'); t.placeholder = 'Ejemplo:\\nAirPods\\nPro x2\\nPro 3 x25\\nMax x7'; t.style.width='100%'; importBox.appendChild(t);
      const importActions = document.createElement('div'); importActions.style.marginTop='6px';
      const importDo = document.createElement('button'); importDo.className='linkish'; importDo.textContent='Importar texto'; importDo.onclick=()=>{ importFromText(cat.id, t.value); t.value=''; importBox.style.display='none'; };
      const importCancel = document.createElement('button'); importCancel.className='linkish'; importCancel.textContent='Cancelar'; importCancel.onclick=()=>{ importBox.style.display='none'; };
      importActions.appendChild(importDo); importActions.appendChild(importCancel); importBox.appendChild(importActions);
      body.appendChild(importBox);

      card.appendChild(body);
      catsEl.appendChild(card);
    });
  }

  // Add / Edit helpers
  function addCategory(name){ state.push({id:uid(),name:name||'Nueva categoria',collapsed:false,models:[]}); save(state); render(); }
  function addModel(catId){ const cat = state.find(c=>c.id===catId); const name = prompt('Nombre del modelo:'); if(name){ cat.models.push({id:uid(),name,variants:[]}); save(state); render(); } }
  function addVariant(catId, modelId){ const cat = state.find(c=>c.id===catId); const model = cat.models.find(m=>m.id===modelId); const name = prompt('Nombre de la variante (ej: Purple o Black (4 indios, 3 americanos)):'); if(!name) return; const qtyStr = prompt('Cantidad (numero):','1'); const qty = Math.max(0, parseInt(qtyStr)||0); model.variants.push({id:uid(),name,qty,note:null}); save(state); render(); }
  function editVariant(catId, modelId, variantId){ const cat = state.find(c=>c.id===catId); const model = cat.models.find(m=>m.id===modelId); const variant = model.variants.find(v=>v.id===variantId); const newName = prompt('Editar nombre variante:', variant.name); if(newName!==null) variant.name = newName; const newQty = prompt('Editar cantidad:', variant.qty); if(newQty!==null) variant.qty = Math.max(0, parseInt(newQty)||0); save(state); render(); }

  // Copy formatted text for a category
  function formatCategory(cat){ let out = '';
    // category between asterisks and underscores as requested: (*_Caja Marron_*)
    out += '(*_' + cat.name + '_*)\n';
    cat.models.forEach(m=>{
      out += m.name + '\n';
      m.variants.forEach(v=>{ if(v.qty>0){ out += v.name + ' x' + v.qty + '\n'; } });
      out += '\n';
    });
    return out.trim();
  }

  async function copyCategory(catId){ const cat = state.find(c=>c.id===catId); const text = formatCategory(cat);
    try{ await navigator.clipboard.writeText(text); toast('Copiado al portapapeles'); }catch(e){ // fallback
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('Copiado (fallback)'); }
  }

  // Export all
  $('#exportAll').onclick = ()=>{
    let out = '';
    state.forEach(cat=>{ out += formatCategory(cat) + '\n\n'; });
    out = out.trim();
    // show in prompt and copy
    try{ navigator.clipboard.writeText(out); toast('Todo copiado al portapapeles'); }catch(e){ prompt('Texto exportado:', out); }
  }

  // import UI toggle
  function toggleImportBox(catId){ const el = document.getElementById('import-'+catId); if(!el) return; el.style.display = el.style.display==='none'?'block':'none'; }

  // Import parser: receives block of text and a category id
  function importFromText(catId, text){ if(!text || !text.trim()) return; const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
    if(lines.length===0) return;
    const cat = state.find(c=>c.id===catId);
    let currentModel = null;
    lines.forEach(line=>{
      // Detect variant by pattern: contains ' x' followed by digits (e.g. 'Pro x2' or 'Black x7 (nota)')
      const variantMatch = line.match(/^(.*)\s+x(\d+)(\s*\(.*\))?$/i);
      if(variantMatch){
        const vname = variantMatch[1].trim();
        const vqty = parseInt(variantMatch[2]);
        const vnote = variantMatch[3] ? variantMatch[3].trim() : null;
        if(!currentModel){ // if no model yet, create a "sin modelo"
          currentModel = {id:uid(),name:'Sin modelo',variants:[]}; cat.models.push(currentModel);
        }
        currentModel.variants.push({id:uid(),name:vname,qty:vqty,note:vnote});
      } else {
        // treat as model line
        currentModel = {id:uid(),name:line,variants:[]};
        cat.models.push(currentModel);
      }
    });
    save(state); render(); toast('Importado'); }

  // Add category button
  $('#addCatBtn').onclick = ()=>{ const name = prompt('Nombre de la categoria:'); if(name) addCategory(name); }

  // Clear / load example
  $('#clearAll').onclick = ()=>{ if(confirm('Eliminar todos los datos guardados?')){ state = []; save(state); render(); } }
  $('#loadExample').onclick = ()=>{ state = sampleData; save(state); render(); }

  // initial render
  render();
  </script>
</body>
</html>
